<script>
    // --- Global State Management (Simulated Backend Data) ---
    // In a real application, this data would come from a secure backend server and database.
    // This is for demonstration of the front-end functionality and user experience.

    const TEACHER_PASSWORD = "0"; // In a real app, this would be hashed and stored securely.
    let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null; // Stores { type: 'student'/'teacher', data: { ... } }

    // Load data from localStorage or initialize empty arrays/objects
    let students = JSON.parse(localStorage.getItem('students')) || [];
    let videos = JSON.parse(localStorage.getItem('videos')) || [];
    let studentLoginLog = JSON.parse(localStorage.getItem('studentLoginLog')) || [];
    let studentWatchHistory = JSON.parse(localStorage.getItem('studentWatchHistory')) || {}; // { studentId: [{ videoId, title, watchedAt }] }
    let quizzes = JSON.parse(localStorage.getItem('quizzes')) || []; // New: Stores quizzes created by teacher
    let studentQuizResults = JSON.parse(localStorage.getItem('studentQuizResults')) || {}; // New: Stores student quiz attempts
    let platformSettings = JSON.parse(localStorage.getItem('platformSettings')) || {
        welcomeMessage: "أهلاً بكم في منصة مستر أحمد الشورى التعليمية!",
        contactEmail: "support@yourdomain.com",
        contactPhone: "010XXXXXXXXX",
        securityLevel: "عادي"
    };


    // Save data to localStorage (simulated persistence)
    function saveData() {
        localStorage.setItem('students', JSON.stringify(students));
        localStorage.setItem('videos', JSON.stringify(videos));
        localStorage.setItem('studentLoginLog', JSON.stringify(studentLoginLog));
        localStorage.setItem('studentWatchHistory', JSON.stringify(studentWatchHistory));
        localStorage.setItem('quizzes', JSON.stringify(quizzes)); // Save quizzes
        localStorage.setItem('studentQuizResults', JSON.stringify(studentQuizResults)); // Save quiz results
        localStorage.setItem('platformSettings', JSON.stringify(platformSettings));
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); // Persist current user session
    }

    // --- UI Helper Functions ---
    function showMessage(elementId, message, isSuccess = false) {
        const messageElement = document.getElementById(elementId);
        messageElement.textContent = message;
        messageElement.classList.remove('success', 'error'); // Remove both
        if (isSuccess) {
            messageElement.classList.add('success');
        } else {
            messageElement.classList.add('error');
        }
        messageElement.classList.add('show');
        setTimeout(() => {
            messageElement.classList.remove('show');
            messageElement.textContent = ''; // Clear message after fading
        }, 3000); // Hide after 3 seconds
    }

    function clearFormMessages() {
        document.querySelectorAll('.form-message').forEach(el => {
            el.classList.remove('show', 'success', 'error');
            el.textContent = '';
        });
    }

    // --- Screen Navigation ---
    const screens = document.querySelectorAll('.container');

    function showScreen(screenId) {
        screens.forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
        window.scrollTo(0, 0); // Scroll to top when changing screens
    }

    // --- Authentication Screen Logic ---
    function showAuthForm(type) {
        document.getElementById('student-tab').classList.remove('active');
        document.getElementById('teacher-tab').classList.remove('active');
        document.getElementById('student-form').classList.remove('active');
        document.getElementById('teacher-form').classList.remove('active');

        if (type === 'student') {
            document.getElementById('student-tab').classList.add('active');
            document.getElementById('student-form').classList.add('active');
        } else {
            document.getElementById('teacher-tab').classList.add('active');
            document.getElementById('teacher-form').classList.add('active');
        }
        clearFormMessages();
    }

    document.getElementById('student-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearFormMessages();
        const name = document.getElementById('student-name').value.trim();
        const phone = document.getElementById('student-phone').value.trim();
        const profilePicFile = document.getElementById('student-profile-pic-upload').files[0];
        const gradeType = document.getElementById('student-grade-type').value;
        const grade = document.getElementById('student-grade').value;
        const messageElementId = 'student-form-message';

        if (!name || !phone || !gradeType || !grade) {
            showMessage(messageElementId, 'الرجاء إدخال جميع البيانات المطلوبة.', false);
            return;
        }

        const nameParts = name.split(' ');
        if (nameParts.length < 3) {
            showMessage(messageElementId, 'الرجاء إدخال الاسم كاملاً (ثلاثي).', false);
            return;
        }

        if (!/^(01)[0-9]{9}$/.test(phone)) {
            showMessage(messageElementId, 'الرجاء إدخال رقم هاتف مصري صحيح (يبدأ بـ 01 و11 رقمًا).', false);
            return;
        }

        // Simulate student registration/login
        let student = students.find(s => s.phone === phone);
        let profilePicUrl = 'https://via.placeholder.com/150/ADD8E6/FFFFFF?text=Student'; // Default avatar

        const processLogin = (picUrl) => {
            if (!student) {
                // New student registration
                student = {
                    id: Date.now().toString(), // Unique ID for simplicity
                    name: name,
                    phone: phone,
                    profilePic: picUrl,
                    gradeType: gradeType,
                    grade: grade,
                    loginCount: 0,
                    registrationDate: new Date().toLocaleDateString('ar-EG')
                };
                students.push(student);
                showMessage(messageElementId, 'تم التسجيل بنجاح! جاري تحويلك لمنصة الطالب.', true);
            } else {
                // Existing student login
                showMessage(messageElementId, 'أهلاً بك مجدداً! جاري تحويلك لمنصة الطالب.', true);
                // Update grade/type if changed (optional, could be denied in real app)
                student.gradeType = gradeType;
                student.grade = grade;
                if (picUrl !== profilePicUrl) { // Only update if a new picture was uploaded
                    student.profilePic = picUrl;
                }
            }

            student.loginCount++;
            studentLoginLog.unshift({
                name: student.name,
                phone: student.phone,
                time: new Date().toLocaleString('ar-EG', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                })
            });
            if (studentLoginLog.length > 50) studentLoginLog.pop(); // Keep log manageable

            currentUser = {
                type: 'student',
                data: student
            };
            saveData();

            setTimeout(() => {
                updateStudentDashboard();
                showScreen('student-dashboard');
            }, 1000);
        };

        if (profilePicFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePicUrl = e.target.result;
                processLogin(profilePicUrl);
            };
            reader.readAsDataURL(profilePicFile);
        } else {
            processLogin(student ? student.profilePic : profilePicUrl); // Use existing pic if available, otherwise default
        }
    });

    document.getElementById('teacher-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearFormMessages();
        const password = document.getElementById('teacher-password').value;
        const messageElementId = 'teacher-form-message';

        if (password === TEACHER_PASSWORD) {
            showMessage(messageElementId, 'تسجيل دخول ناجح! جاري تحويلك للوحة تحكم المعلم.', true);
            currentUser = {
                type: 'teacher',
                data: {
                    name: 'مستر أحمد الشورى',
                    id: 'teacher1'
                }
            }; // Simulate teacher data

            setTimeout(() => {
                updateTeacherDashboard();
                showScreen('teacher-dashboard');
            }, 1000);
        } else {
            showMessage(messageElementId, 'كلمة المرور غير صحيحة. حاول مرة أخرى.', false);
        }
    });

    // --- Teacher Dashboard Logic ---
    function updateTeacherDashboard() {
        if (currentUser && currentUser.type === 'teacher') {
            // Update stats
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-videos').textContent = videos.length;
            document.getElementById('total-quizzes').textContent = quizzes.length; // New: Total quizzes

            // Calculate average engagement (simplified for demo: count unique students who watched at least one video)
            const uniqueViewers = new Set();
            for (const studentId in studentWatchHistory) {
                if (studentWatchHistory[studentId].length > 0) {
                    uniqueViewers.add(studentId);
                }
            }
            document.getElementById('avg-engagement').textContent = students.length > 0 ? (uniqueViewers.size / students.length * 100).toFixed(0) + '%' : '0%';

            // Update student login log
            const logList = document.getElementById('student-login-log');
            logList.innerHTML = '';
            if (studentLoginLog.length === 0) {
                logList.innerHTML = '<li><i class="fas fa-info-circle"></i> لا توجد سجلات دخول حديثة.</li>';
            } else {
                studentLoginLog.forEach(log => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${log.name} (${log.phone})</span> <span class="log-time">${log.time}</span>`;
                    logList.appendChild(li);
                });
            }

            // Update registered students table
            const studentsTableBody = document.getElementById('registered-students-body');
            studentsTableBody.innerHTML = '';
            if (students.length === 0) {
                studentsTableBody.innerHTML = '<tr><td colspan="7" class="no-content-table">لا يوجد طلاب مسجلون حتى الآن.</td></tr>';
            } else {
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    const watchedCount = studentWatchHistory[student.id] ? studentWatchHistory[student.id].length : 0;
                    const completedQuizzesCount = studentQuizResults[student.id] ? Object.keys(studentQuizResults[student.id]).length : 0; // New: completed quizzes

                    tr.innerHTML = `
                            <td data-label="الاسم">${student.name}</td>
                            <td data-label="رقم الهاتف">${student.phone}</td>
                            <td data-label="الصف">${student.grade}</td>
                            <td data-label="نوع الصف">${student.gradeType}</td>
                            <td data-label="عدد الفيديوهات المشاهدة">${watchedCount}</td>
                            <td data-label="عدد الاختبارات المكتملة">${completedQuizzesCount}</td>
                            <td data-label="تفاصيل إضافية"><button class="btn outline-btn" onclick="viewStudentDetails('${student.id}')"><i class="fas fa-eye"></i> عرض</button></td>
                        `;
                    studentsTableBody.appendChild(tr);
                });
            }

            renderTeacherVideos(); // Ensure videos are rendered when managing videos section is active
            renderManageQuizzes(); // Render quizzes for teacher
            loadPlatformSettings(); // Load settings when teacher dashboard is updated
        }
    }

    function showTeacherSection(sectionId) {
        document.querySelectorAll('#teacher-dashboard .dashboard-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        document.querySelectorAll('#teacher-dashboard .sidebar-nav ul li a').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`#teacher-dashboard .sidebar-nav ul li a[onclick*="showTeacherSection('${sectionId}')"]`).classList.add('active');

        // Re-render data for specific sections when they become active
        if (sectionId === 'manage-videos') {
            renderTeacherVideos();
        } else if (sectionId === 'student-stats' || sectionId === 'student-list') {
            updateTeacherDashboard(); // Re-render stats and student list
        } else if (sectionId === 'platform-settings') {
            loadPlatformSettings();
        } else if (sectionId === 'manage-quizzes') {
            renderManageQuizzes();
        }
    }

    document.getElementById('upload-video-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        clearFormMessages();

        const title = document.getElementById('video-title').value.trim();
        const description = document.getElementById('video-description').value.trim();
        const videoUrlInput = document.getElementById('video-url').value.trim(); // رابط الفيديو الخارجي
        const targetGradeType = document.getElementById('video-target-grade-type').value;
        const targetGrade = document.getElementById('video-target-grade').value;
        const messageElementId = 'upload-video-message';
        const uploadSpinner = document.getElementById('upload-spinner');

        if (!title || !videoUrlInput || !targetGradeType || !targetGrade) {
            showMessage(messageElementId, 'الرجاء إدخال عنوان الفيديو ورابط الفيديو والصف المستهدف.', false);
            return;
        }

        uploadSpinner.style.display = 'block';
        showMessage(messageElementId, 'جاري معالجة الفيديو...', true);

        let thumbnailUrl = 'https://via.placeholder.com/320x200/ADD8E6/FFFFFF?text=Video+Thumbnail'; // الصورة المصغرة الافتراضية
        let processedVideoUrl = videoUrlInput; // الرابط الذي سيتم استخدامه في المشغل

        if (videoUrlInput.includes('youtube.com') || videoUrlInput.includes('youtu.be')) {
            let videoId = '';
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = videoUrlInput.match(youtubeRegex);
            if (match && match[1]) {
                videoId = match[1];
                thumbnailUrl = `https://img.youtube.com/vi/$${videoId}/hqdefault.jpg`;
                processedVideoUrl = `https://www.youtube.com/embed/$${videoId}?autoplay=1&controls=1&showinfo=0&rel=0&modestbranding=1&enablejsapi=1`;
            } else {
                showMessage(messageElementId, 'رابط يوتيوب غير صالح.', false);
                uploadSpinner.style.display = 'none';
                return;
            }
        } else if (videoUrlInput.includes('drive.google.com')) {
            const driveRegex = /file\/d\/([a-zA-Z0-9_-]+)(?:\/view)?/;
            const match = videoUrlInput.match(driveRegex);
            if (match && match[1]) {
                const fileId = match[1];
                processedVideoUrl = `https://docs.google.com/file/d/${fileId}/preview`;
            } else {
                showMessage(messageElementId, 'رابط جوجل درايف غير صالح. تأكد من أنه رابط ملف مباشر أو معاينة.', false);
                uploadSpinner.style.display = 'none';
                return;
            }
        } else {
            showMessage(messageElementId, 'الرجاء إدخال رابط يوتيوب أو جوجل درايف. ستظهر الصورة المصغرة الافتراضية للفيديوهات الأخرى.', true);
        }

        document.getElementById('video-thumbnail-url').value = thumbnailUrl;

        setTimeout(() => {
            const videoId = Date.now().toString();

            const newVideo = {
                id: videoId,
                title: title,
                description: description,
                thumbnail: thumbnailUrl,
                videoUrl: processedVideoUrl,
                originalUrl: videoUrlInput,
                targetGradeType: targetGradeType,
                targetGrade: targetGrade,
                uploadDate: new Date().toLocaleDateString('ar-EG'),
                views: 0
            };

            videos.push(newVideo);
            saveData();
            uploadSpinner.style.display = 'none';
            showMessage(messageElementId, 'تم إضافة الفيديو بنجاح!', true);
            document.getElementById('upload-video-form').reset();
            renderTeacherVideos();
            updateTeacherDashboard();
        }, 1500);
    });


    function renderTeacherVideos() {
        const teacherVideoList = document.getElementById('teacher-video-list');
        teacherVideoList.innerHTML = ''; // Clear previous videos

        if (videos.length === 0) {
            teacherVideoList.innerHTML = `
                <div class="no-content">
                    <p><i class="fas fa-exclamation-circle"></i> لا توجد فيديوهات مرفوعة حتى الآن.</p>
                    <button class="btn primary-btn" onclick="showTeacherSection('upload-video')"><i class="fas fa-plus-circle"></i> ابدأ برفع فيديو جديد</button>
                </div>
            `;
            return;
        }

        const sortedVideos = [...videos].sort((a, b) => {
            const dateA = new Date(a.uploadDate.split('/').reverse().join('-'));
            const dateB = new Date(b.uploadDate.split('/').reverse().join('-'));
            return dateB - dateA;
        });


        sortedVideos.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.classList.add('video-card');
            videoCard.innerHTML = `
                <img src="${video.thumbnail}" alt="${video.title}">
                <div class="video-card-info">
                    <h3>${video.title}</h3>
                    <p>${video.description}</p>
                    <div class="video-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${video.uploadDate}</span>
                        <span><i class="fas fa-eye"></i> ${video.views} مشاهدة</span>
                    </div>
                    <div class="video-meta">
                        <span><i class="fas fa-tag"></i> ${video.targetGrade} (${video.targetGradeType})</span>
                    </div>
                    <div class="video-actions">
                        <button class="btn primary-btn" onclick="openVideoPlayer('${video.id}', false)"><i class="fas fa-play"></i> مشاهدة</button>
                        <button class="btn outline-btn" onclick="deleteVideo('${video.id}')"><i class="fas fa-trash-alt"></i> حذف</button>
                    </div>
                </div>
            `;
            teacherVideoList.appendChild(videoCard);
        });
    }

    function deleteVideo(videoId) {
        if (confirm('هل أنت متأكد من حذف هذا الفيديو؟ هذا الإجراء لا يمكن التراجع عنه.')) {
            videos = videos.filter(v => v.id !== videoId);
            for (const studentId in studentWatchHistory) {
                studentWatchHistory[studentId] = studentWatchHistory[studentId].filter(item => item.videoId !== videoId);
            }
            saveData();
            renderTeacherVideos();
            updateTeacherDashboard();
        }
    }

    function viewStudentDetails(studentId) {
        const student = students.find(s => s.id === studentId);
        if (student) {
            let details = `
                الاسم: ${student.name}
                رقم الهاتف: ${student.phone}
                الصف: ${student.grade} (${student.gradeType})
                مرات تسجيل الدخول: ${student.loginCount}
                تاريخ التسجيل: ${student.registrationDate}
            `;
            const studentWatched = studentWatchHistory[student.id] || [];
            if (studentWatched.length > 0) {
                details += '\n\nالفيديوهات المشاهدة:';
                studentWatched.forEach(item => {
                    details += `\n- ${item.title} (شوهد في: ${item.watchedAt})`;
                });
            } else {
                details += '\n\nلم يشاهد الطالب أي فيديوهات بعد.';
            }

            const studentQuizAttempts = studentQuizResults[student.id] || {};
            const completedQuizzes = Object.values(studentQuizAttempts);
            if (completedQuizzes.length > 0) {
                details += '\n\nنتائج الاختبارات:';
                completedQuizzes.forEach(quizAttempt => {
                    details += `\n- ${quizAttempt.quizTitle}: ${quizAttempt.score}/${quizAttempt.totalQuestions} (في: ${quizAttempt.attemptedAt})`;
                });
            } else {
                details += '\n\nلم يكمل الطالب أي اختبارات بعد.';
            }

            alert('تفاصيل الطالب:\n\n' + details);
        }
    }

    document.getElementById('platform-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearFormMessages();

        const welcomeMessage = document.getElementById('welcome-message').value.trim();
        const contactEmail = document.getElementById('contact-email').value.trim();
        const contactPhone = document.getElementById('contact-phone').value.trim();
        const securityLevel = document.getElementById('security-level').value;
        const messageElementId = 'settings-message';

        if (!welcomeMessage || !contactEmail || !contactPhone || !securityLevel) {
            showMessage(messageElementId, 'الرجاء ملء جميع حقول الإعدادات.', false);
            return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contactEmail)) {
            showMessage(messageElementId, 'الرجاء إدخال بريد إلكتروني صحيح.', false);
            return;
        }
        if (!/^(01)[0-9]{9}$/.test(contactPhone)) {
            showMessage(messageElementId, 'الرجاء إدخال رقم هاتف صحيح (يبدأ بـ 01 و11 رقمًا).', false);
            return;
        }

        platformSettings = {
            welcomeMessage,
            contactEmail,
            contactPhone,
            securityLevel
        };
        saveData();
        showMessage(messageElementId, 'تم حفظ الإعدادات بنجاح!', true);
    });

    function loadPlatformSettings() {
        document.getElementById('welcome-message').value = platformSettings.welcomeMessage;
        document.getElementById('contact-email').value = platformSettings.contactEmail;
        document.getElementById('contact-phone').value = platformSettings.contactPhone;
        document.getElementById('security-level').value = platformSettings.securityLevel;
    }

    function logoutTeacher() {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        showScreen('auth-screen');
        showAuthForm('teacher');
        document.getElementById('teacher-password').value = '';
        showMessage('teacher-form-message', 'تم تسجيل الخروج بنجاح.', true);
    }

    function updateStudentDashboard() {
        if (currentUser && currentUser.type === 'student') {
            const student = currentUser.data;
            document.getElementById('student-dashboard-name').textContent = student.name;
            document.getElementById('student-profile-name').textContent = student.name;
            document.getElementById('student-profile-info').textContent = `${student.grade} - ${student.gradeType}`;
            document.getElementById('student-sidebar-avatar').src = student.profilePic;

            document.getElementById('edit-student-name').value = student.name;
            document.getElementById('edit-student-phone').value = student.phone;
            document.getElementById('edit-student-grade-type').value = student.gradeType;
            document.getElementById('edit-student-grade').value = student.grade;

            renderStudentVideos(student.grade, student.gradeType);
            renderStudentQuizzes(student.grade, student.gradeType);
            updateStudentProgress(student.id);
        }
    }

    function showStudentSection(sectionId) {
        document.querySelectorAll('#student-dashboard .dashboard-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        document.querySelectorAll('#student-dashboard .sidebar-nav ul li a').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`#student-dashboard .sidebar-nav ul li a[onclick*="showStudentSection('${sectionId}')"]`).classList.add('active');

        if (sectionId === 'my-progress') {
            updateStudentProgress(currentUser.data.id);
        } else if (sectionId === 'my-profile') {
            updateStudentDashboard();
        } else if (sectionId === 'my-quizzes') {
            renderStudentQuizzes(currentUser.data.grade, currentUser.data.gradeType);
            document.getElementById('active-quiz-container').style.display = 'none';
            document.getElementById('quiz-submission-result').style.display = 'none';
        }
    }

    document.getElementById('edit-profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearFormMessages();
        const student = currentUser.data;
        const newName = document.getElementById('edit-student-name').value.trim();
        const newProfilePicFile = document.getElementById('edit-student-profile-pic').files[0];
        const messageElementId = 'edit-profile-message';

        if (!newName) {
            showMessage(messageElementId, 'الرجاء إدخال الاسم كاملاً.', false);
            return;
        }
        const nameParts = newName.split(' ');
        if (nameParts.length < 3) {
            showMessage(messageElementId, 'الرجاء إدخال الاسم كاملاً (ثلاثي).', false);
            return;
        }

        const updateProfile = (picUrl) => {
            student.name = newName;
            student.profilePic = picUrl;

            const studentIndex = students.findIndex(s => s.id === student.id);
            if (studentIndex !== -1) {
                students[studentIndex] = student;
            }

            currentUser.data = student;

            saveData();
            showMessage(messageElementId, 'تم حفظ التغييرات بنجاح!', true);
            updateStudentDashboard();
        };

        if (newProfilePicFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                updateProfile(e.target.result);
            };
            reader.readAsDataURL(newProfilePicFile);
        } else {
            updateProfile(student.profilePic);
        }
    });


    function renderStudentVideos(grade, gradeType) {
        const studentVideoGrid = document.getElementById('student-video-grid');
        studentVideoGrid.innerHTML = '';

        const filteredVideos = videos.filter(video =>
            video.targetGrade === grade && video.targetGradeType === gradeType
        );

        if (filteredVideos.length === 0) {
            studentVideoGrid.innerHTML = `
                <div class="no-content">
                    <p><i class="fas fa-info-circle"></i> لا توجد فيديوهات متاحة لصفك حالياً.</p>
                    <p>تأكد من اختيار الصف الصحيح عند تسجيل الدخول أو تواصل مع المستر.</p>
                </div>
            `;
            return;
        }

        const sortedVideos = [...filteredVideos].sort((a, b) => {
            const dateA = new Date(a.uploadDate.split('/').reverse().join('-'));
            const dateB = new Date(b.uploadDate.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        sortedVideos.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.classList.add('video-card');
            videoCard.setAttribute('onclick', `openVideoPlayer('${video.id}', true)`);
            videoCard.innerHTML = `
                <img src="${video.thumbnail}" alt="${video.title}">
                <div class="video-card-info">
                    <h3>${video.title}</h3>
                    <p>${video.description}</p>
                    <div class="video-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${video.uploadDate}</span>
                        <span><i class="fas fa-eye"></i> ${video.views} مشاهدة</span>
                    </div>
                </div>
            `;
            studentVideoGrid.appendChild(videoCard);
        });
    }

    function updateStudentProgress(studentId) {
        const historyList = document.getElementById('student-watch-history');
        historyList.innerHTML = '';
        let totalEstimatedWatchTimeMinutes = 0;

        const studentHistory = studentWatchHistory[studentId] || [];

        if (studentHistory.length === 0) {
            historyList.innerHTML = '<li><i class="fas fa-info-circle"></i> لا توجد سجلات مشاهدة حتى الآن.</li>';
        } else {
            const sortedHistory = [...studentHistory].sort((a, b) => new Date(b.watchedAt) - new Date(a.watchedAt));

            sortedHistory.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span><i class="fas fa-play-circle"></i> ${item.title}</span> <span class="watch-time">مشاهدة في ${item.watchedAt}</span>`;
                historyList.appendChild(li);
                totalEstimatedWatchTimeMinutes += 5;
            });
        }

        document.getElementById('videos-watched-count').textContent = studentHistory.length;
        document.getElementById('total-watch-time').textContent = `${totalEstimatedWatchTimeMinutes} دقيقة`;

        const quizResultsList = document.getElementById('student-quiz-results');
        quizResultsList.innerHTML = '';
        const studentQuizzes = studentQuizResults[studentId] || {};
        const completedQuizzes = Object.values(studentQuizzes);

        if (completedQuizzes.length === 0) {
            quizResultsList.innerHTML = '<li><i class="fas fa-info-circle"></i> لا توجد نتائج اختبارات حتى الآن.</li>';
        } else {
            const sortedQuizResults = [...completedQuizzes].sort((a, b) => new Date(b.attemptedAt) - new Date(a.attemptedAt));
            sortedQuizResults.forEach(result => {
                const li = document.createElement('li');
                const statusClass = result.score >= (result.totalQuestions / 2) ? 'correct-answer' : 'wrong-answer';
                li.innerHTML = `<span><i class="fas fa-clipboard-check"></i> ${result.quizTitle}: <strong class="${statusClass}">${result.score}/${result.totalQuestions}</strong></span> <span class="watch-time">اكتمل في ${result.attemptedAt}</span>`;
                quizResultsList.appendChild(li);
            });
        }
        document.getElementById('quizzes-completed-count').textContent = completedQuizzes.length;
    }

    function logoutStudent() {
        currentUser = null;
        sessionStorage.removeItem('currentUser');
        showScreen('auth-screen');
        showAuthForm('student');
        document.getElementById('student-name').value = '';
        document.getElementById('student-phone').value = '';
        document.getElementById('student-profile-pic-upload').value = '';
        document.getElementById('student-grade-type').value = '';
        document.getElementById('student-grade').value = '';
        showMessage('student-form-message', 'تم تسجيل الخروج بنجاح.', true);
    }

    const videoModal = document.getElementById('video-modal');
    const videoWrapper = document.querySelector('.video-wrapper');
    const modalVideoTitle = document.getElementById('modal-video-title');
    const modalVideoDescription = document.getElementById('modal-video-description');
    const modalViewCount = document.getElementById('modal-view-count');

    function applyVideoSecuritySettings(playerElement) {
        const level = platformSettings.securityLevel;
        playerElement.oncontextmenu = () => false;
        if (playerElement.tagName === 'VIDEO') {
            playerElement.controlsList = 'nodownload';
            playerElement.disablePictureInPicture = true;
        }

        if (playerElement.tagName === 'IFRAME' && playerElement.src.includes('youtube.com/embed')) {
            // YouTube security settings are handled via URL parameters.
        } else if (playerElement.tagName === 'VIDEO') {
            if (level === 'متوسط') {
                playerElement.controlsList += ' nofullscreen';
            } else if (level === 'عالي') {
                playerElement.controlsList += ' nofullscreen noplaybackrate';
                document.addEventListener('keydown', handleScreenshotKeys);
            }
        }
    }

    function handleScreenshotKeys(event) {
        const forbiddenKeys = ['PrintScreen', 'Meta', 'Alt'];
        if (forbiddenKeys.includes(event.key) || (event.ctrlKey && event.shiftKey && event.key === 's') || (event.ctrlKey && event.key === 'p')) {
            event.preventDefault();
            alert("تم تعطيل لقطات الشاشة لحماية المحتوى.");
        }
    }

    function openVideoPlayer(videoId, isStudentView = false) {
        const video = videos.find(v => v.id === videoId);
        if (video) {
            videoWrapper.innerHTML = '';

            modalVideoTitle.textContent = video.title;
            modalVideoDescription.textContent = video.description;
            modalViewCount.textContent = video.views;

            let playerElement;

            if (video.videoUrl.includes('youtube.com/embed')) {
                playerElement = document.createElement('iframe');
                playerElement.setAttribute('src', video.videoUrl);
                playerElement.setAttribute('frameborder', '0');
                playerElement.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
                playerElement.setAttribute('allowfullscreen', '');
            } else {
                playerElement = document.createElement('video');
                playerElement.setAttribute('controls', '');
                playerElement.setAttribute('autoplay', '');
                playerElement.setAttribute('src', video.videoUrl);
                playerElement.textContent = 'متصفحك لا يدعم تشغيل الفيديوهات.';
            }
            playerElement.style.position = 'absolute';
            playerElement.style.top = '0';
            playerElement.style.left = '0';
            playerElement.style.width = '100%';
            playerElement.style.height = '100%';
            videoWrapper.appendChild(playerElement);

            applyVideoSecuritySettings(playerElement);

            videoModal.style.display = 'flex';

            if (isStudentView && currentUser && currentUser.type === 'student') {
                const studentId = currentUser.data.id;
                if (!studentWatchHistory[studentId]) {
                    studentWatchHistory[studentId] = [];
                }
                const alreadyWatched = studentWatchHistory[studentId].some(item => item.videoId === videoId);
                if (!alreadyWatched) {
                    video.views++;
                    modalViewCount.textContent = video.views;
                    studentWatchHistory[studentId].push({
                        videoId: video.id,
                        title: video.title,
                        watchedAt: new Date().toLocaleString('ar-EG', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        })
                    });
                    saveData();
                    updateStudentProgress(studentId);
                }
            }
        } else {
            alert('عفواً، الفيديو غير موجود أو لا يمكن الوصول إليه.');
        }
    }

    function closeVideoModal() {
        videoWrapper.innerHTML = '';
        videoModal.style.display = 'none';
        document.removeEventListener('keydown', handleScreenshotKeys);

        if (currentUser && currentUser.type === 'student') {
            renderStudentVideos(currentUser.data.grade, currentUser.data.gradeType);
        } else if (currentUser && currentUser.type === 'teacher') {
            renderTeacherVideos();
        }
    }

    window.onclick = function(event) {
        if (event.target === videoModal) {
            closeVideoModal();
        }
    }

    let questionCounter = 1;

    function addQuestion() {
        questionCounter++;
        const container = document.getElementById('quiz-questions-container');
        const newQuestionBlock = document.createElement('div');
        newQuestionBlock.classList.add('question-block');
        newQuestionBlock.innerHTML = `
            <label>السؤال ${questionCounter}:</label>
            <input type="text" class="question-text" placeholder="نص السؤال" required>
            <label>الخيارات:</label>
            <input type="text" class="option-text" placeholder="الخيار أ" required>
            <input type="radio" name="q${questionCounter}-answer" value="0" required> (صحيح)<br>
            <input type="text" class="option-text" placeholder="الخيار ب" required>
            <input type="radio" name="q${questionCounter}-answer" value="1"> (صحيح)<br>
            <input type="text" class="option-text" placeholder="الخيار ج" required>
            <input type="radio" name="q${questionCounter}-answer" value="2"> (صحيح)<br>
            <input type="text" class="option-text" placeholder="الخيار د" required>
            <input type="radio" name="q${questionCounter}-answer" value="3"> (صحيح)<br>
            <button type="button" class="btn outline-btn" style="margin-top:10px;" onclick="removeQuestion(this)"><i class="fas fa-minus-circle"></i> حذف السؤال</button>
        `;
        container.appendChild(newQuestionBlock);
    }

    function removeQuestion(buttonElement) {
        buttonElement.closest('.question-block').remove();
    }

    document.getElementById('create-quiz-form').addEventListener('submit', function(e) {
        e.preventDefault();
        clearFormMessages();
        const quizTitle = document.getElementById('quiz-title').value.trim();
        const quizDuration = parseInt(document.getElementById('quiz-duration').value);
        const targetGradeType = document.getElementById('quiz-target-grade-type').value;
        const targetGrade = document.getElementById('quiz-target-grade').value;
        const messageElementId = 'create-quiz-message';

        if (!quizTitle || !quizDuration || !targetGradeType || !targetGrade) {
            showMessage(messageElementId, 'الرجاء ملء جميع حقول الاختبار الأساسية.', false);
            return;
        }

        const questions = [];
        const questionBlocks = document.querySelectorAll('#quiz-questions-container .question-block');
        if (questionBlocks.length === 0) {
            showMessage(messageElementId, 'الرجاء إضافة سؤال واحد على الأقل للاختبار.', false);
            return;
        }

        for (let i = 0; i < questionBlocks.length; i++) {
            const qBlock = questionBlocks[i];
            const questionText = qBlock.querySelector('.question-text').value.trim();
            const options = Array.from(qBlock.querySelectorAll('.option-text')).map(input => input.value.trim());
            const correctAnswerIndex = qBlock.querySelector(`input[name="q${i+1}-answer"]:checked`)?.value;

            if (!questionText || options.some(opt => !opt) || correctAnswerIndex === undefined) {
                showMessage(messageElementId, `الرجاء ملء جميع بيانات السؤال ${i+1} وتحديد الإجابة الصحيحة.`, false);
                return;
            }
            questions.push({
                question: questionText,
                options: options,
                correctAnswer: parseInt(correctAnswerIndex)
            });
        }

        const newQuiz = {
            id: Date.now().toString(),
            title: quizTitle,
            duration: quizDuration,
            targetGradeType: targetGradeType,
            targetGrade: targetGrade,
            questions: questions,
            creationDate: new Date().toLocaleDateString('ar-EG')
        };

        quizzes.push(newQuiz);
        saveData();
        showMessage(messageElementId, 'تم حفظ الاختبار بنجاح!', true);
        document.getElementById('create-quiz-form').reset();
        document.getElementById('quiz-questions-container').innerHTML = '';
        questionCounter = 0;
        addQuestion();
        renderManageQuizzes();
        updateTeacherDashboard();
    });

    function renderManageQuizzes() {
        const quizzesListDiv = document.getElementById('quizzes-list');
        quizzesListDiv.innerHTML = '';

        if (quizzes.length === 0) {
            quizzesListDiv.innerHTML = `
                <div class="no-content">
                    <p><i class="fas fa-exclamation-circle"></i> لا توجد اختبارات متاحة حتى الآن.</p>
                    <button class="btn primary-btn" onclick="showTeacherSection('create-quiz')"><i class="fas fa-plus-circle"></i> إنشاء اختبار جديد</button>
                </div>
            `;
            return;
        }

        const sortedQuizzes = [...quizzes].sort((a, b) => {
            const dateA = new Date(a.creationDate.split('/').reverse().join('-'));
            const dateB = new Date(b.creationDate.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        sortedQuizzes.forEach(quiz => {
            const quizCard = document.createElement('div');
            quizCard.classList.add('quiz-card');
            quizCard.innerHTML = `
                <h3>${quiz.title}</h3>
                <p>المدة: ${quiz.duration} دقيقة</p>
                <p>الأسئلة: ${quiz.questions.length}</p>
                <p>الصف المستهدف: ${quiz.targetGrade} (${quiz.targetGradeType})</p>
                <p>تاريخ الإنشاء: ${quiz.creationDate}</p>
                <div class="btn-group">
                    <button class="btn primary-btn" onclick="viewQuizDetailsTeacher('${quiz.id}')"><i class="fas fa-eye"></i> عرض التفاصيل</button>
                    <button class="btn outline-btn" onclick="deleteQuiz('${quiz.id}')"><i class="fas fa-trash-alt"></i> حذف</button>
                </div>
            `;
            quizzesListDiv.appendChild(quizCard);
        });
    }

    function viewQuizDetailsTeacher(quizId) {
        const quiz = quizzes.find(q => q.id === quizId);
        if (quiz) {
            let details = `عنوان الاختبار: ${quiz.title}\nالمدة: ${quiz.duration} دقيقة\nالصف المستهدف: ${quiz.targetGrade} (${quiz.targetGradeType})\nتاريخ الإنشاء: ${quiz.creationDate}\n\nالأسئلة:\n`;
            quiz.questions.forEach((q, index) => {
                details += `\nسؤال ${index + 1}: ${q.question}\n`;
                q.options.forEach((opt, optIndex) => {
                    details += `  ${String.fromCharCode(65 + optIndex)}. ${opt} ${optIndex === q.correctAnswer ? '(الإجابة الصحيحة)' : ''}\n`;
                });
            });
            alert(details);
        }
    }

    function deleteQuiz(quizId) {
        if (confirm('هل أنت متأكد من حذف هذا الاختبار؟ هذا الإجراء لا يمكن التراجع عنه.')) {
            quizzes = quizzes.filter(q => q.id !== quizId);
            for (const studentId in studentQuizResults) {
                delete studentQuizResults[studentId][quizId];
            }
            saveData();
            renderManageQuizzes();
            updateTeacherDashboard();
        }
    }

    let currentActiveQuiz = null;
    let quizTimerInterval;
    let quizTimeRemaining;

    function renderStudentQuizzes(grade, gradeType) {
        const studentQuizzesListDiv = document.getElementById('student-quizzes-list');
        studentQuizzesListDiv.innerHTML = '';

        const filteredQuizzes = quizzes.filter(quiz =>
            quiz.targetGrade === grade && quiz.targetGradeType === gradeType
        );

        if (filteredQuizzes.length === 0) {
            studentQuizzesListDiv.innerHTML = `
                <div class="no-content">
                    <p><i class="fas fa-exclamation-circle"></i> لا توجد اختبارات متاحة لك حالياً.</p>
                    <p>قد يتم إضافة اختبارات جديدة قريباً، أو تواصل مع المستر للمزيد من المعلومات.</p>
                </div>
            `;
            return;
        }

        const studentId = currentUser.data.id;
        const sortedQuizzes = [...filteredQuizzes].sort((a, b) => {
            const dateA = new Date(a.creationDate.split('/').reverse().join('-'));
            const dateB = new Date(b.creationDate.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        sortedQuizzes.forEach(quiz => {
            const quizCard = document.createElement('div');
            quizCard.classList.add('quiz-card');
            const hasAttempted = studentQuizResults[studentId] && studentQuizResults[studentId][quiz.id];
            const buttonText = hasAttempted ? '<i class="fas fa-history"></i> عرض النتيجة' : '<i class="fas fa-play"></i> ابدأ الاختبار';
            const buttonAction = hasAttempted ? `viewStudentQuizResult('${quiz.id}')` : `startQuiz('${quiz.id}')`;
            const buttonClass = hasAttempted ? 'secondary-btn' : 'primary-btn';

            quizCard.innerHTML = `
                <h3>${quiz.title}</h3>
                <p>المدة: ${quiz.duration} دقيقة</p>
                <p>عدد الأسئلة: ${quiz.questions.length}</p>
                <p>تاريخ الإنشاء: ${quiz.creationDate}</p>
                <div class="btn-group">
                    <button class="btn ${buttonClass}" onclick="${buttonAction}">${buttonText}</button>
                </div>
            `;
            studentQuizzesListDiv.appendChild(quizCard);
        });
    }

    function startQuiz(quizId) {
        const quiz = quizzes.find(q => q.id === quizId);
        if (!quiz) {
            alert('عفواً، الاختبار غير موجود.');
            return;
        }

        const studentId = currentUser.data.id;
        if (studentQuizResults[studentId] && studentQuizResults[studentId][quiz.id]) {
            alert('لقد أكملت هذا الاختبار بالفعل. يمكنك عرض نتيجتك من صفحة التقدم الدراسي.');
            return;
        }

        currentActiveQuiz = quiz;
        document.getElementById('student-quizzes-list').style.display = 'none';
        document.getElementById('active-quiz-container').style.display = 'block';
        document.getElementById('active-quiz-title').textContent = quiz.title;
        document.getElementById('quiz-submission-result').style.display = 'none';

        displayQuizQuestions(quiz.questions);
        startQuizTimer(quiz.duration);

        document.getElementById('current-quiz-form').onsubmit = function(e) {
            e.preventDefault();
            submitQuiz();
        };
    }

    function displayQuizQuestions(questions) {
        const quizQuestionsDisplay = document.getElementById('quiz-questions-display');
        quizQuestionsDisplay.innerHTML = '';
        questions.forEach((q, qIndex) => {
            const questionBlock = document.createElement('div');
            questionBlock.classList.add('question-block');
            questionBlock.innerHTML = `<h4>سؤال ${qIndex + 1}: ${q.question}</h4>`;
            q.options.forEach((option, optIndex) => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="radio" name="question-${qIndex}" value="${optIndex}"> ${option}`;
                questionBlock.appendChild(label);
            });
            quizQuestionsDisplay.appendChild(questionBlock);
        });
    }

    function startQuizTimer(durationMinutes) {
        quizTimeRemaining = durationMinutes * 60;
        const timerDisplay = document.getElementById('quiz-timer');
        timerDisplay.textContent = `الوقت المتبقي: ${formatTime(quizTimeRemaining)}`;

        quizTimerInterval = setInterval(() => {
            quizTimeRemaining--;
            timerDisplay.textContent = `الوقت المتبقي: ${formatTime(quizTimeRemaining)}`;
            if (quizTimeRemaining <= 0) {
                clearInterval(quizTimerInterval);
                alert('انتهى الوقت! سيتم تسليم الاختبار تلقائياً.');
                submitQuiz(true);
            }
        }, 1000);
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function submitQuiz(timeUp = false) {
        clearInterval(quizTimerInterval);
        const studentId = currentUser.data.id;
        const quizForm = document.getElementById('current-quiz-form');
        let correctAnswers = 0;
        const studentAnswers = {};

        currentActiveQuiz.questions.forEach((q, qIndex) => {
            const selectedOption = quizForm.querySelector(`input[name="question-${qIndex}"]:checked`);
            const studentAnswerIndex = selectedOption ? parseInt(selectedOption.value) : -1;
            studentAnswers[qIndex] = studentAnswerIndex;

            if (studentAnswerIndex === q.correctAnswer) {
                correctAnswers++;
            }

            const questionBlock = quizForm.querySelector(`.question-block:nth-child(${qIndex + 1})`);
            Array.from(questionBlock.querySelectorAll('input[type="radio"]')).forEach((radio, optIndex) => {
                const label = radio.closest('label');
                label.classList.remove('selected-answer');

                if (optIndex === q.correctAnswer) {
                    label.classList.add('correct-answer');
                }
                if (optIndex === studentAnswerIndex && optIndex !== q.correctAnswer) {
                    label.classList.add('wrong-answer');
                }
                if (optIndex === studentAnswerIndex) {
                    label.classList.add('selected-answer');
                }
                radio.disabled = true;
            });
        });

        const totalQuestions = currentActiveQuiz.questions.length;
        const resultDiv = document.getElementById('quiz-submission-result');
        resultDiv.style.display = 'block';
        let resultMessage = '';
        let resultClass = '';

        if (timeUp) {
            resultMessage = `انتهى الوقت! حصلت على ${correctAnswers} من ${totalQuestions} إجابات صحيحة.`;
            resultClass = correctAnswers >= (totalQuestions / 2) ? 'success' : 'fail';
        } else {
            resultMessage = `تم تسليم الاختبار! حصلت على ${correctAnswers} من ${totalQuestions} إجابات صحيحة.`;
            resultClass = correctAnswers >= (totalQuestions / 2) ? 'success' : 'fail';
        }
        resultDiv.textContent = resultMessage;
        resultDiv.className = `quiz-result ${resultClass}`;

        if (!studentQuizResults[studentId]) {
            studentQuizResults[studentId] = {};
        }
        studentQuizResults[studentId][currentActiveQuiz.id] = {
            quizTitle: currentActiveQuiz.title,
            score: correctAnswers,
            totalQuestions: totalQuestions,
            attemptedAt: new Date().toLocaleString('ar-EG', {
                dateStyle: 'medium',
                timeStyle: 'short'
            }),
            studentAnswers: studentAnswers
        };
        saveData();
        updateStudentProgress(studentId);

        quizForm.querySelector('button[type="submit"]').disabled = true;

        const backToQuizzesBtn = document.createElement('button');
        backToQuizzesBtn.classList.add('btn', 'primary-btn');
        backToQuizzesBtn.textContent = 'العودة للاختبارات';
        backToQuizzesBtn.style.marginTop = '20px';
        backToQuizzesBtn.onclick = () => {
            currentActiveQuiz = null;
            document.getElementById('active-quiz-container').style.display = 'none';
            document.getElementById('student-quizzes-list').style.display = 'block';
            document.getElementById('current-quiz-form').querySelector('button[type="submit"]').disabled = false;
            renderStudentQuizzes(currentUser.data.grade, currentUser.data.gradeType);
        };
        resultDiv.appendChild(backToQuizzesBtn);
    }

    function viewStudentQuizResult(quizId) {
        const studentId = currentUser.data.id;
        const quizAttempt = studentQuizResults[studentId] && studentQuizResults[studentId][quizId];
        const quiz = quizzes.find(q => q.id === quizId);

        if (!quizAttempt || !quiz) {
            alert('لا توجد نتيجة لهذا الاختبار أو الاختبار غير موجود.');
            return;
        }

        document.getElementById('student-quizzes-list').style.display = 'none';
        document.getElementById('active-quiz-container').style.display = 'block';
        document.getElementById('active-quiz-title').textContent = `${quiz.title} - نتيجتك`;
        document.getElementById('quiz-timer').textContent = '';
        clearInterval(quizTimerInterval);

        const quizQuestionsDisplay = document.getElementById('quiz-questions-display');
        quizQuestionsDisplay.innerHTML = '';

        quiz.questions.forEach((q, qIndex) => {
            const questionBlock = document.createElement('div');
            questionBlock.classList.add('question-block');
            questionBlock.innerHTML = `<h4>سؤال ${qIndex + 1}: ${q.question}</h4>`;

            const studentAnswerIndex = quizAttempt.studentAnswers[qIndex];

            q.options.forEach((option, optIndex) => {
                const label = document.createElement('label');
                label.textContent = `${String.fromCharCode(65 + optIndex)}. ${option}`;

                if (optIndex === q.correctAnswer) {
                    label.classList.add('correct-answer');
                    label.textContent += ' (الإجابة الصحيحة)';
                }
                if (optIndex === studentAnswerIndex && optIndex !== q.correctAnswer) {
                    label.classList.add('wrong-answer');
                    label.textContent += ' (إجابتك)';
                } else if (optIndex === studentAnswerIndex && optIndex === q.correctAnswer) {
                    label.classList.add('selected-answer');
                    label.textContent += ' (إجابتك الصحيحة)';
                }
                questionBlock.appendChild(label);
            });
            quizQuestionsDisplay.appendChild(questionBlock);
        });

        document.getElementById('current-quiz-form').querySelector('button[type="submit"]').style.display = 'none';

        const resultDiv = document.getElementById('quiz-submission-result');
        resultDiv.style.display = 'block';
        const resultClass = quizAttempt.score >= (quizAttempt.totalQuestions / 2) ? 'success' : 'fail';
        resultDiv.textContent = `نتيجتك: ${quizAttempt.score} من ${quizAttempt.totalQuestions} إجابات صحيحة (في: ${quizAttempt.attemptedAt})`;
        resultDiv.className = `quiz-result ${resultClass}`;

        const backToQuizzesBtn = document.createElement('button');
        backToQuizzesBtn.classList.add('btn', 'primary-btn');
        backToQuizzesBtn.textContent = 'العودة للاختبارات';
        backToQuizzesBtn.style.marginTop = '20px';
        backToQuizzesBtn.onclick = () => {
            currentActiveQuiz = null;
            document.getElementById('active-quiz-container').style.display = 'none';
            document.getElementById('student-quizzes-list').style.display = 'block';
            document.getElementById('current-quiz-form').querySelector('button[type="submit"]').style.display = 'block';
            renderStudentQuizzes(currentUser.data.grade, currentUser.data.gradeType);
        };
        resultDiv.appendChild(backToQuizzesBtn);
    }

    function startPollingForUpdates() {
        setInterval(() => {
            if (currentUser && currentUser.type === 'student') {
                const updatedVideos = JSON.parse(localStorage.getItem('videos')) || [];
                const updatedQuizzes = JSON.parse(localStorage.getItem('quizzes')) || [];

                if (JSON.stringify(videos) !== JSON.stringify(updatedVideos)) {
                    videos = updatedVideos;
                    renderStudentVideos(currentUser.data.grade, currentUser.data.gradeType);
                }

                if (JSON.stringify(quizzes) !== JSON.stringify(updatedQuizzes)) {
                    quizzes = updatedQuizzes;
                    if (!currentActiveQuiz) {
                        renderStudentQuizzes(currentUser.data.grade, currentUser.data.gradeType);
                    }
                }
            }
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('create-quiz')) {
            addQuestion();
        }
        if (currentUser) {
            if (currentUser.type === 'teacher') {
                updateTeacherDashboard();
                showScreen('teacher-dashboard');
            } else if (currentUser.type === 'student') {
                updateStudentDashboard();
                showScreen('student-dashboard');
                startPollingForUpdates();
            }
        } else {
            showScreen('landing-page');
            showAuthForm('student');
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
            alert('هذه الميزة معطلة لأسباب أمنية.');
        }
    });

    document.addEventListener('copy', function(e) {
        e.preventDefault();
        alert('نسخ المحتوى غير مسموح به.');
    });

    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
    });

</script>
